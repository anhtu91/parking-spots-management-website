{% extends "base.html" %}

{% block content %}
<html lang="en">

<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
$(function(){
    var select_keyid_invite = $('#keyid_list_invite');
    var select_keyid_parking_spots = $('#your_select_keyid');    
    var select_fieldname_parking_spots = $('#your_select_fieldname');

    $('#invited_day').datepicker({
        minDate: 0,
        maxDate: '+1w-3D',
        beforeShowDay: $.datepicker.noWeekends
    });

    select_keyid_invite.on('change', function(){
        var selected_keyid = select_keyid_invite.val();
        
        $.ajax({
            type: 'POST',
            url: '/fieldname',
            data: JSON.stringify(selected_keyid),
            contentType: 'application/json',
            success: function(response_data) {
                $("#fieldname_list").empty();
            
                console.log(response_data)
                for (var i = 0; i < response_data.length; i++) {
                    $("#fieldname_list").append($('<option value="' +response_data[i]+ '">' + response_data[i] + '</option>'));
                }
            }
        });
    });

    

    select_keyid_parking_spots.on('change', function(){
        var selected_keyid = select_keyid_parking_spots.val();
        
        $.ajax({
            type: 'POST',
            url: '/fieldname',
            data: JSON.stringify(selected_keyid),
            contentType: 'application/json',
            success: function(response_data) {
                $("#your_select_fieldname").empty();
            
                console.log(response_data)
                for (var i = 0; i < response_data.length; i++) {
                    $("#your_select_fieldname").append($('<option value="' +response_data[i]+ '">' + response_data[i] + '</option>'));
                }
            }
        });
    });

    $('#add_spots').click(function(e){
        var selected_keyid = select_keyid_parking_spots.val();
        var selected_fieldname = select_fieldname_parking_spots.val();

        $.ajax({
            type: 'POST',
            url: '/addspots',
            data: JSON.stringify({"keyid": selected_keyid, "fieldname": selected_fieldname}),
            contentType: 'application/json',
            success: function(response_data) {
                alert("success")
                console.log(response_data);
                var table = document.getElementById("parking_spots_list");
                table.innerHTML="";
                var tr="";

                response_data.forEach(element => {
                    tr+='<tr>';
                    tr+='<td>'+element.keyid+'</td>'+'<td>'+element.fieldname+'</td>'
                    tr+='</tr>'
                });

                table.innerHTML+=tr;
            }
        });
    });

    $('#remove_spots').click(function(e){
        var selected_keyid = select_keyid_parking_spots.val();
        var selected_fieldname = select_fieldname_parking_spots.val();

        $.ajax({
            type: 'POST',
            url: '/removespots',
            data: JSON.stringify({"keyid": selected_keyid, "fieldname": selected_fieldname}),
            contentType: 'application/json',
            success: function(response_data) {
                alert("success")
                console.log(response_data);
                var table = document.getElementById("parking_spots_list");
                table.innerHTML="";
                var tr="";

                response_data.forEach(element => {
                    tr+='<tr>';
                    tr+='<td>'+element.keyid+'</td>'+'<td>'+element.fieldname+'</td>'
                    tr+='</tr>'
                });

                table.innerHTML+=tr;
            }
        });
    });
});
</script>
</head>

<style>
    .form-wrapper {
        width: 70%;
        margin: 0 auto;
        text-align: center;
    }
    .form {
      background-color: rgb(255, 148, 9);
      color: rgb(7, 1, 1);
      border: 2px solid black;
      margin: 20px;
      padding: 20px;
    }

    .approveTermsContainer{
        display:flex;
        justify-content:center;
    }

    .table-container {
        height: 29em;
    }
    table {
        display: flex;
        flex-flow: column;
        height: 100%;
        width: 100%;
    }
    table thead {
        /* head takes the height it requires, 
        and it's not scaled when table is resized */
        flex: 0 0 auto;
        width: calc(100% - 0.5em);
    }
    table tbody {
        /* body takes all the remaining available space */
        flex: 1 1 auto;
        display: block;
        overflow-y: scroll;
    }
    table tbody tr {
        width: 100%;
    }
    table thead,
    table tbody tr {
        display: table;
        table-layout: fixed;
    }
    /* decorations */
    .table-container {
        border: 1px solid black;
        padding: 0.3em;
    }
    table {
        border: 1px solid lightgrey;
    }
    table td, table th {
        padding: 0.3em;
        border: 1px solid lightgrey;
    }
    table th {
        border: 1px solid grey;
    }
   
</style>

<h1 class="title">
    Welcome, {{name}}! <br><br>
</h1>
<div id="form-wrapper">
    <form style="width: 820px; height: 800px; float: left;">
        <div class="form" style="height: 800px;">
            <div class="approvedItems">
                <label for="form_label"><p style="font-size:130%;"><b>Your selected parking spots:.</b></label><br><br>
                <div class="table-container">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>KeyID</th>
                                    <th>FieldName</th>
                                 
                                </tr>
                            </thead>
                            <tbody id="parking_spots_list">
                                {% for spot in user_parking_spots %}
                                    <tr>
                                        <td>{{ spot.keyid }}</td>
                                        <td>{{ spot.fieldname }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <br><br>

            <div class="approveTermsContainer">
                <div class="newItems" style="margin: 0 auto; padding:0px;">
                    
                    <label for="keyid">KeyID of parking spots:</label><br>
                    <select name ="your_select_keyid" id="your_select_keyid" style="width: 400px" required>
                        <option value="" selected disabled hidden>Choose here</option>
                        {% for keyid in keyids %}
                            <option value ="{{keyid}}">{{keyid}}</option>
                        {% endfor %}
                    </select>

                    <br><br>

                    <label for="fieldname">FieldName of parking spots:</label><br>
                    <select name ="your_select_fieldname" id="your_select_fieldname" style="width: 400px" required>
                    </select>

                    <br><br>

                    <input type="button" id="add_spots" style="width: 100px" value="Add"/>
                    <input type="button" id="remove_spots" style="width: 100px" value="Remove"/>
                </div>
            </div>

        </div>
    </form>

    <form style="width: 500px; height: 500px; float: right;" action="/invite" method="POST">
        <div class="form" style="height: 448px;">
            <div class="control">
                <label for="form_label"><p style="font-size:130%;"><b>Invite friend to your parking spots.</b></p></label><br>
            </div>
            
            <div class="control">
                <label for="keyid">KeyID of parking spots:</label><br>
                <select name ="keyid_list_invite" id="keyid_list_invite" style="width: 400px" required>
                    <option value="" selected disabled hidden>Choose here</option>
                    {% for keyid in keyids %}
                        <option value ="{{keyid}}">{{keyid}}</option>
                    {% endfor %}
                </select><br><br>
            </div>
            
            <div class="control">
                <label for="fieldname">FieldName of parking spots:</label><br>
                <select name ="fieldname_list" id="fieldname_list" style="width: 400px" required>
                    
                </select><br><br>
            </div>
    
            <div class="control">
                <label for="Date">Date/time:</label><br>
                <input type="date" id="invited_day" name="invited_day" style="width: 130px" required>
                <input type="time" id="invited_time" name="invited_time" style="width: 120px" required><br><br>
            </div>
    
            <div class="control">
                <label for="email">Invited email:</label><br>
                <input type="email" id="email" name="email" style="width: 400px" required><br><br>
            </div>
            
            <div>
                {% with messages = get_flashed_messages(category_filter=["danger"]) %}
                    {% if messages %}
                        <div class="notification is-danger">
                            {{ messages[0] }}
                        </div>
                    {% endif %}
                {% endwith %}
            
                {% with messages = get_flashed_messages(category_filter=["success"]) %}
                    {% if messages %}
                        <div class="notification is-success">
                            {{ messages[0] }}
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
            
            <br>

            <div class="control">
                <input type="submit" name="invite" style="width: 100px" value="Invite">
            </div>
        </div>
    </form>

    <form style="width: 500px; height: 200px; float: right;" action="/resendmqttcert" method="POST">
        <div class="form" style="height: 200px;">
            <div class="control">
                <label for="form_label"><p style="font-size:130%;"><b>Resend MQTT Certificate to your email.</b></p></label><br>
                <div class="field">
                    <div class="control">
                        New Certificate Password:
                        <input class="input" type="password" name="mqttPassword" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters" required>
                    </div>
                </div>
                <div class="control">
                    <input type="submit" name="resend" style="width: 100px" value="Resend">
                </div>
            </div>
        </div>
    </form>
</div>

</html>
{% endblock %}